# {{ ansible_managed }}

# Container management bridge
auto br-mgmt
iface br-mgmt inet static
  bridge_stp off
  bridge_waitport 0
  bridge_fd 0
  # Bridge port references tagged interface
  bridge_ports {{ item.value.device1 }}.{{ TARGET_HOST_NETWORKING.host_network.container_vlan_id }}
  address {{ TARGET_HOST_NETWORKING.container_network.subnet }}.{{ TARGET_HOST_NETWORKING.container_network.mgmt_subnet }}.{{ item.value.ip.split('.')[3] }}
  netmask {{ TARGET_HOST_NETWORKING.container_network.netmask }}
  dns-nameservers {{ TARGET_HOST_NETWORKING.host_network.dns_servers }}

# Storage bridge (optional)
auto br-storage
iface br-storage inet static
  bridge_stp off
  bridge_waitport 0
  bridge_fd 0
  # Bridge port reference tagged interface
  bridge_ports {{ item.value.device1 }}.{{ TARGET_HOST_NETWORKING.host_network.storage_vlan_id }}
  address {{ TARGET_HOST_NETWORKING.container_network.subnet }}.{{ TARGET_HOST_NETWORKING.container_network.storage_subnet }}.{{ item.value.ip.split('.')[3] }}
  netmask {{ TARGET_HOST_NETWORKING.container_network.netmask }}
  mtu 9000

# OpenStack Networking VXLAN (tunnel/overlay) bridge
auto br-vxlan
iface br-vxlan inet static
  bridge_stp off
  bridge_waitport 0
  bridge_fd 0
  # Bridge port references tagged interface
  bridge_ports {{ item.value.device2 }}.{{ TARGET_HOST_NETWORKING.host_network.tunnel_vlan_id }}
  address {{ TARGET_HOST_NETWORKING.container_network.subnet }}.{{ TARGET_HOST_NETWORKING.container_network.tunnel_subnet }}.{{ item.value.ip.split('.')[3] }}
  netmask {{ TARGET_HOST_NETWORKING.container_network.netmask }}
  mtu 9000

# OpenStack Networking VLAN bridge
auto br-vlan
  iface br-vlan inet manual
  bridge_stp off
  bridge_waitport 0
  bridge_fd 0
  # Bridge port references untagged interface
  bridge_ports {{ item.value.device2 }}
  address {{ item.value.prod_ip }}
  netmask {{ TARGET_HOST_NETWORKING.prod_network.netmask }}
  post-up ip rule add from {{ TARGET_HOST_NETWORKING.prod_network.subnet }}.0/22 table custom
  post-up ip route add default via {{ TARGET_HOST_NETWORKING.prod_network.subnet }}.1 dev br-vlan table custom
